import Head from "next/head";
import React, {
  createContext,
  useState,
  useEffect,
  lazy,
  Suspense,
} from "react";
import Navbar from "@/components/_organisms/NavBar";
import { HeroProps } from "@/components/_organisms/Hero";
import { SocialLinks } from "@/components/_organisms/Footer";
import { AboutProps } from "@/components/_organisms/About";
import { SpeedInsights } from "@vercel/speed-insights/next";

type ThemeContextType = {
  darkMode: boolean;
  toggleTheme: () => void;
};

const ThemeContext = createContext<ThemeContextType>({
  darkMode: false,
  toggleTheme: () => {},
});

const Hero = lazy(() => import("@/components/_organisms/Hero"));
const Footer = lazy(() => import("@/components/_organisms/Footer"));
const About = lazy(() => import("@/components/_organisms/About"));

export default function Home() {
  const [darkMode, setDarkMode] = useState(false);
  const [infoData, setInfoData] = useState<HeroProps | null>(null);
  const [aboutData, setAboutData] = useState<AboutProps | null>(null);
  const [socialLinks, setSocialLinks] = useState<SocialLinks | null>(null);
  const toggleTheme = () => {
    setDarkMode(!darkMode);
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch("/api/allData");
        const result = await response.json();

        if (result?.info) {
          setInfoData(result.info);
          setAboutData(result.info.About);
          setSocialLinks(result.socialLinks);
        }
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    };

    fetchData();
  }, []);

  return (
    <>
      <Head>
        <title>Avinash Rao | Portfolio</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/favicon.svg' />
      </Head>
      <ThemeContext.Provider value={{ darkMode, toggleTheme }}>
        <main className={`${darkMode ? "bg-gray-800 p-4" : "p-4"}`}>
          <Navbar />
          <Suspense fallback={<div>Loading...</div>}>
            {infoData && <Hero info={infoData?.info} />}
          </Suspense>
          <Suspense fallback={<div>Loading...</div>}>
            {aboutData && <About about={aboutData} />}
          </Suspense>
          <Suspense fallback={<div>Loading...</div>}>
            {socialLinks && <Footer socialLinks={socialLinks} />}
          </Suspense>
          <SpeedInsights />
        </main>
      </ThemeContext.Provider>
    </>
  );
}